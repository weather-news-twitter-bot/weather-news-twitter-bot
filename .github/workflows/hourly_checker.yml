name: ğŸ”„ Weather News Hourly Checker

on:
  schedule:
    # JST 19:00 (UTC 10:00) ã‹ã‚‰ ç¿Œæ—¥ JST 17:00 (UTC 8:00) ã¾ã§1æ™‚é–“æ¯ã«å®Ÿè¡Œ
    - cron: '0 10-23,0-8 * * *' 
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # GitHub API ã®å®Ÿè¡Œã«å¿…è¦ãªæ¨©é™
    permissions:
      actions: read
      contents: read 

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # 1. GitHub API (gh api) ã‚’ä½¿ç”¨ã—ã¦ArtifactãŒå­˜åœ¨ã™ã‚‹å®Ÿè¡ŒIDã‚’å–å¾—
    #    -> ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦æœ€æ–°ã®å®Ÿè¡ŒIDã‚’ç¢ºå®Ÿã«å–å¾—
    # -------------------------------------------------------------
    - name: ğŸ” Find Run ID by Artifact existence (Final Fix)
      id: find_run
      run: |
        # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
        CURRENT_BRANCH=${{ github.ref_name }}
        
        # Artifactsãƒªã‚¹ãƒˆã‹ã‚‰ã€ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã® Artifact ãŒç´ã¥ãå®Ÿè¡ŒIDã‚’å–å¾—
        ARTIFACT_ID=$(gh api \
          -H "Accept: application/vnd.github.v3+json" \
          /repos/${{ github.repository }}/actions/artifacts | \
          jq -r --arg name "latest-schedule-data" \
          --arg branch "$CURRENT_BRANCH" \
          '.artifacts[] | select(.name == $name and .workflow_run.head_branch == $branch) | .workflow_run.id' | head -n 1)

        if [ -n "$ARTIFACT_ID" ]; then
          echo "Found Artifact Run ID: $ARTIFACT_ID on branch $CURRENT_BRANCH"
          echo "runId=$ARTIFACT_ID" >> $GITHUB_OUTPUT
        else
          echo "No active artifact found on branch $CURRENT_BRANCH. Skipping check."
          echo "runId=" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -------------------------------------------------------------
    # 2. Artifactã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè¡ŒIDã‚’æŒ‡å®šã—ã€å¤±æ•—ã‚’è¨±å®¹ï¼‰
    # -------------------------------------------------------------
    - name: ğŸ“¦ Download Previous Schedule Artifact
      id: download_artifact_step
      uses: actions/download-artifact@v4
      # Findã‚¹ãƒ†ãƒƒãƒ—ã§ runId ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: steps.find_run.outputs.runId != '' 
      with:
        name: latest-schedule-data
        path: . 
        run-id: ${{ steps.find_run.outputs.runId }}
      continue-on-error: true 

    # -------------------------------------------------------------
    # 3. Pythonã®ç’°å¢ƒæ§‹ç¯‰ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      if: steps.download_artifact_step.outcome == 'success'
      with:
        python-version: '3.11'

    - name: Install dependencies and Playwright Browsers
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps
      if: steps.download_artifact_step.outcome == 'success'

    # -------------------------------------------------------------
    # 4. ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: ğŸ”„ Run Checker Bot
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        EXECUTION_MODE: 'check'
        TZ: 'Asia/Tokyo'
      run: python src/weather_bot.py
      if: steps.download_artifact_step.outcome == 'success'
      
    # -------------------------------------------------------------
    # 5. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Pythonå®Ÿè¡ŒæˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: â¬†ï¸ Re-Upload Updated Schedule Artifact
      uses: actions/upload-artifact@v4
      if: steps.download_artifact_step.outcome == 'success' && success()
      with:
        name: latest-schedule-data
        path: schedule_data.json
        overwrite: true
        retention-days: 1
