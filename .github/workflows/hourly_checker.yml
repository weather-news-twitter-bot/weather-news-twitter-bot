name: ğŸ”„ Weather News Hourly Checker

on:
  schedule:
    # JST 19:00 (UTC 10:00) ã‹ã‚‰ ç¿Œæ—¥ JST 17:00 (UTC 8:00) ã¾ã§1æ™‚é–“æ¯ã«å®Ÿè¡Œ
    - cron: '0 10-23,0-8 * * *' 
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ¨©é™ãŒå¿…è¦ (ã‚³ãƒŸãƒƒãƒˆã‚’è¡Œã†ãŸã‚)
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository (with full history)
      uses: actions/checkout@v4
      with:
        # å±¥æ­´å…¨ä½“ã‚’å–å¾—ã—ãªã„ã¨ã€ã‚³ãƒŸãƒƒãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚
        fetch-depth: 0

    # -------------------------------------------------------------
    # 1. æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ï¼ˆschedule_data.jsonï¼‰ã®å–å¾—
    #    -> ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ç‰¹åˆ¥ãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¸è¦
    # -------------------------------------------------------------
    - name: ğŸ“¦ Retrieve Schedule Data from Repository
      run: |
        # æ—¢ã« checkout ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã¯å–å¾—ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ­ã‚°å‡ºåŠ›ã®ã¿
        if [ -f "schedule_data.json" ]; then
          echo "Schedule data loaded from repository."
        else
          echo "Warning: schedule_data.json not found in repository. Initial check may fail."
        fi

    # -------------------------------------------------------------
    # 2. Pythonã®ç’°å¢ƒæ§‹ç¯‰ 
    # -------------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies and Playwright Browsers
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps

    # -------------------------------------------------------------
    # 3. ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
    # -------------------------------------------------------------
    - name: ğŸ”„ Run Checker Bot
      id: run_checker
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        EXECUTION_MODE: 'check' # ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
        TZ: 'Asia/Tokyo'
      run: python src/weather_bot.py
      
    # -------------------------------------------------------------
    # 4. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ (å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿)
    # -------------------------------------------------------------
    - name: â¬†ï¸ Commit and Push Updated Schedule Data
      # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: success()
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "BOT: Update schedule_data.json after hourly check"
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒŸãƒƒãƒˆ
        files: schedule_data.json
        # GITHUB_TOKENã¯è‡ªå‹•çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹
