name: ğŸ”„ Weather News Hourly Checker

on:
  schedule:
    # JST 19:00 (UTC 10:00) ã‹ã‚‰ ç¿Œæ—¥ JST 17:00 (UTC 8:00) ã¾ã§1æ™‚é–“æ¯ã«å®Ÿè¡Œ
    - cron: '0 10-23,0-8 * * *' 
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # â˜… ä¿®æ­£ 1: åˆå›æŠ•ç¨¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒIDã‚’è¦‹ã¤ã‘ã‚‹
    # -------------------------------------------------------------
    - name: ğŸ” Find Initial Post Workflow Run ID
      id: find_run
      uses: "xt0rted/actions-find-artifact@v2"
      with:
        # åˆå›æŠ•ç¨¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®š
        workflow: weather_news_bot.yml
        artifactName: latest-schedule-data
        branch: ${{ github.ref_name }} 
        status: success # æˆåŠŸã—ãŸå®Ÿè¡Œã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹

    # -------------------------------------------------------------
    # â˜… ä¿®æ­£ 2: Artifactã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè¡ŒIDã‚’æŒ‡å®šã—ã€å¤±æ•—ã‚’è¨±å®¹ï¼‰
    # -------------------------------------------------------------
    - name: ğŸ“¦ Download Previous Schedule Artifact
      id: download_artifact_step
      uses: actions/download-artifact@v4
      # Findã‚¹ãƒ†ãƒƒãƒ—ã§ runId ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: steps.find_run.outputs.runId != '' 
      with:
        name: latest-schedule-data
        path: .
        run-id: ${{ steps.find_run.outputs.runId }}
      # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¦ã‚‚ã‚¸ãƒ§ãƒ–ã‚’ç¶šè¡Œã•ã›ã‚‹ (Artifactä¸åœ¨æ™‚ã®ã‚¬ãƒ¼ãƒ‰)
      continue-on-error: true 

    # -------------------------------------------------------------
    # â˜… ä¿®æ­£ 3: Pythonå®Ÿè¡Œä»¥é™ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã«ã€Artifactãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸã®æ¡ä»¶ã‚’è¿½åŠ 
    # -------------------------------------------------------------
    # ArtifactãŒå­˜åœ¨ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ãŸå ´åˆã®ã¿ã€å¾Œç¶šã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹
    - name: Set up Python
      uses: actions/setup-python@v4
      if: steps.download_artifact_step.outcome == 'success'
      with:
        python-version: '3.11'

    - name: Install dependencies and Playwright Browsers
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps
      if: steps.download_artifact_step.outcome == 'success'

    - name: ğŸ”„ Run Checker Bot
      env:
        # ... (ç’°å¢ƒå¤‰æ•°è¨­å®šã¯çœç•¥) ...
        EXECUTION_MODE: 'check'
        TZ: 'Asia/Tokyo'
      run: python src/weather_bot.py
      if: steps.download_artifact_step.outcome == 'success'
      
    - name: â¬†ï¸ Re-Upload Updated Schedule Artifact
      uses: actions/upload-artifact@v4
      if: steps.download_artifact_step.outcome == 'success'
      with:
        name: latest-schedule-data
        path: schedule_data.json
        overwrite: true
        retention-days: 1
