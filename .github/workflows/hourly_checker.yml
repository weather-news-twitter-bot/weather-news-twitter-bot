name: ğŸ”„ Weather News Hourly Checker

on:
  schedule:
    # JST 19:00 (UTC 10:00) ã‹ã‚‰ ç¿Œæ—¥ JST 17:00 (UTC 8:00) ã¾ã§1æ™‚é–“æ¯ã«å®Ÿè¡Œ
    - cron: '0 10-23,0-8 * * *' 
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # GitHub API ã®å®Ÿè¡Œã«å¿…è¦ãªæ¨©é™ã€‚contents: read ã¯ API ã‚¢ã‚¯ã‚»ã‚¹ã«å¿…é ˆã€‚
    permissions:
      actions: read
      contents: read 

    steps:
    - name: Checkout repository
      uses: actions:checkout@v4

    # -------------------------------------------------------------
    # 1. GitHub API (gh api) ã‚’ä½¿ç”¨ã—ã¦ArtifactãŒå­˜åœ¨ã™ã‚‹å®Ÿè¡ŒIDã‚’å–å¾—
    #    -> ArtifactãŒå­˜åœ¨ã™ã‚‹æœ€æ–°ã® Run ID ã‚’ç›´æ¥ç‰¹å®šã™ã‚‹
    # -------------------------------------------------------------
    - name: ğŸ” Find Run ID by Artifact existence
      id: find_run
      run: |
        # Artifactsãƒªã‚¹ãƒˆã‹ã‚‰æœ€æ–°ã® 'latest-schedule-data' ãŒç´ã¥ãå®Ÿè¡ŒIDã‚’å–å¾—
        # ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸç„¡åŠ¹ãª Run ID (ä¾‹: 3377983690) ã®å–å¾—ã‚’é¿ã‘ã‚‹
        ARTIFACT_ID=$(gh api \
          -H "Accept: application/vnd.github.v3+json" \
          /repos/${{ github.repository }}/actions/artifacts?name=latest-schedule-data | \
          jq -r '.artifacts[] | select(.name == "latest-schedule-data") | .workflow_run.id' | head -n 1)

        if [ -n "$ARTIFACT_ID" ]; then
          echo "Found Artifact Run ID: $ARTIFACT_ID"
          echo "runId=$ARTIFACT_ID" >> $GITHUB_OUTPUT
        else
          echo "No active artifact found. Skipping check."
          echo "runId=" >> $GITHUB_OUTPUT
        fi
      env:
        # gh CLIèªè¨¼ã®ãŸã‚ã«GITHUB_TOKENã‚’ä½¿ç”¨
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -------------------------------------------------------------
    # 2. Artifactã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè¡ŒIDã‚’æŒ‡å®šã—ã€å¤±æ•—ã‚’è¨±å®¹ï¼‰
    # -------------------------------------------------------------
    - name: ğŸ“¦ Download Previous Schedule Artifact
      id: download_artifact_step
      uses: actions:download-artifact@v4
      # Findã‚¹ãƒ†ãƒƒãƒ—ã§ runId ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: steps.find_run.outputs.runId != '' 
      with:
        name: latest-schedule-data
        path: . # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« schedule_data.json ãŒé…ç½®ã•ã‚Œã‚‹
        run-id: ${{ steps.find_run.outputs.runId }}
      # ArtifactãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å¤±æ•—ã™ã‚‹ãŒã€ã‚¸ãƒ§ãƒ–ã¯ç¶šè¡Œã•ã‚Œã‚‹
      continue-on-error: true 

    # -------------------------------------------------------------
    # 3. Pythonã®ç’°å¢ƒæ§‹ç¯‰ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: Set up Python
      uses: actions:setup-python@v4
      # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: steps.download_artifact_step.outcome == 'success'
      with:
        python-version: '3.11'

    - name: Install dependencies and Playwright Browsers
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps
      if: steps.download_artifact_step.outcome == 'success'

    # -------------------------------------------------------------
    # 4. ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: ğŸ”„ Run Checker Bot
      env:
        # Twitter API Keys (GitHub Secrets)
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        # Bot Settings
        EXECUTION_MODE: 'check' # ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
        TZ: 'Asia/Tokyo'
      run: python src/weather_bot.py
      if: steps.download_artifact_step.outcome == 'success'
      
    # -------------------------------------------------------------
    # 5. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Pythonå®Ÿè¡ŒæˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: â¬†ï¸ Re-Upload Updated Schedule Artifact
      uses: actions:upload-artifact@v4
      # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ AND Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      if: steps.download_artifact_step.outcome == 'success' && success()
      with:
        name: latest-schedule-data
        path: schedule_data.json
        overwrite: true # å¤‰æ›´å¾Œã®çŠ¶æ…‹ã‚’ä¸Šæ›¸ãã—ã¦å†æ¤œå‡ºã‚’é˜²ã
        retention-days: 1
