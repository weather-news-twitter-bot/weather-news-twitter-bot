name: ğŸ”„ Weather News Hourly Checker

on:
  schedule:
    # JST 19:00 (UTC 10:00) ã‹ã‚‰ ç¿Œæ—¥ JST 17:00 (UTC 8:00) ã¾ã§1æ™‚é–“æ¯ã«å®Ÿè¡Œ
    - cron: '0 10-23,0-8 * * *' 
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # GitHub CLI (gh run list) ã®å®Ÿè¡Œã«å¿…è¦ãªæ¨©é™
    permissions:
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # 1. GitHub CLI ã‚’ä½¿ç”¨ã—ã¦åˆå›æŠ•ç¨¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒIDã‚’è¦‹ã¤ã‘ã‚‹
    # -------------------------------------------------------------
    - name: ğŸ” Find Initial Post Workflow Run ID using gh cli
      id: find_run
      run: |
        # åˆå›æŠ•ç¨¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆweather_news_bot.ymlï¼‰ã®æœ€æ–°ã®æˆåŠŸã—ãŸå®Ÿè¡ŒIDã‚’å–å¾—
        # jqã‚’ä½¿ã£ã¦JSONã‹ã‚‰IDã‚’æŠ½å‡º
        RUN_ID=$(gh run list --workflow=weather_news_bot.yml --status=success --limit 1 --json databaseId | jq -r '.[0].databaseId')
        
        if [ "$RUN_ID" != "null" ] && [ -n "$RUN_ID" ]; then
          echo "Found Run ID: $RUN_ID"
          echo "runId=$RUN_ID" >> $GITHUB_OUTPUT
        else
          echo "No successful run found for artifact download. Skipping check."
          echo "runId=" >> $GITHUB_OUTPUT
        fi
      env:
        # gh CLIèªè¨¼ã®ãŸã‚ã«GITHUB_TOKENã‚’ä½¿ç”¨ï¼ˆè‡ªå‹•æä¾›ã•ã‚Œã‚‹ï¼‰
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -------------------------------------------------------------
    # 2. Artifactã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè¡ŒIDã‚’æŒ‡å®šã—ã€å¤±æ•—ã‚’è¨±å®¹ï¼‰
    # -------------------------------------------------------------
    - name: ğŸ“¦ Download Previous Schedule Artifact
      id: download_artifact_step
      uses: actions/download-artifact@v4
      # Findã‚¹ãƒ†ãƒƒãƒ—ã§ runId ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: steps.find_run.outputs.runId != '' 
      with:
        name: latest-schedule-data
        path: . # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« schedule_data.json ãŒé…ç½®ã•ã‚Œã‚‹
        run-id: ${{ steps.find_run.outputs.runId }}
      # ArtifactãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å¤±æ•—ã™ã‚‹ãŒã€ã‚¸ãƒ§ãƒ–ã¯ç¶šè¡Œã•ã‚Œã‚‹
      continue-on-error: true 

    # -------------------------------------------------------------
    # 3. Pythonã®ç’°å¢ƒæ§‹ç¯‰ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      if: steps.download_artifact_step.outcome == 'success'
      with:
        python-version: '3.11'

    - name: Install dependencies and Playwright Browsers
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps
      if: steps.download_artifact_step.outcome == 'success'

    # -------------------------------------------------------------
    # 4. ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: ğŸ”„ Run Checker Bot
      env:
        # Twitter API Keys (GitHub Secrets)
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        # Bot Settings
        EXECUTION_MODE: 'check' # ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
        TZ: 'Asia/Tokyo'
      run: python src/weather_bot.py
      if: steps.download_artifact_step.outcome == 'success'
      
    # -------------------------------------------------------------
    # 5. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Pythonå®Ÿè¡ŒæˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œ)
    # -------------------------------------------------------------
    - name: â¬†ï¸ Re-Upload Updated Schedule Artifact
      uses: actions/upload-artifact@v4
      # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ AND Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      if: steps.download_artifact_step.outcome == 'success' && success()
      with:
        name: latest-schedule-data
        path: schedule_data.json
        overwrite: true # å¤‰æ›´å¾Œã®çŠ¶æ…‹ã‚’ä¸Šæ›¸ãã—ã¦å†æ¤œå‡ºã‚’é˜²ã
        retention-days: 1
